<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Electricity Tracker</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <nav>
        <div class="nav-brand">‚ö° Electricity Tracker</div>
        <div class="nav-links">
            <a href="/dashboard" class="nav-btn">üè† Dashboard</a>
            <a href="/voucher" class="nav-btn">üí≥ Add Voucher</a>
            <a href="/reading" class="nav-btn">üìä Add Reading</a>
            <a href="/history" class="nav-btn">üìù History</a>
            <a href="/settings" class="nav-btn">‚öôÔ∏è Settings</a>
            <a href="#" id="logout" class="nav-btn logout">üö™ Log Out</a>
        </div>
    </nav>
    
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>üìä Electricity Tracker Dashboard</h1>
            <p class="dashboard-subtitle">Track your electricity consumption and costs</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-content">
                    <h3 id="totalAmount">R0.00</h3>
                    <p>TOTAL SPENT</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ö°</div>
                <div class="stat-content">
                    <h3 id="totalUnits">0 kWh</h3>
                    <p>TOTAL KWH</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-content">
                    <h3 id="avgCost">R0.00/kWh</h3>
                    <p>AVG COST</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìã</div>
                <div class="stat-content">
                    <h3 id="totalVat">R0.00</h3>
                    <p>TOTAL VAT</p>
                </div>
            </div>
        </div>

        <div class="dashboard-sections">
            <div class="section-header">
                <h2>üìÖ Last 6 Months</h2>
            </div>
            
            <div class="monthly-grid" id="monthlyGrid">
                <div class="monthly-card">
                    <h4>Loading...</h4>
                    <h3>R0.00</h3>
                    <p>0 kWh</p>
                    <small>Calculating...</small>
                </div>
            </div>

            <div class="section-header">
                <h2>üìà Usage Analytics</h2>
            </div>
            
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h4>Monthly Consumption</h4>
                    <div class="chart-placeholder">
                        <p>Chart showing monthly usage trends</p>
                    </div>
                </div>
                <div class="analytics-card">
                    <h4>üìÑ Recent Vouchers</h4>
                    <div class="recent-list" id="recentVouchers">
                        <div class="recent-item">
                            <span>Loading...</span>
                            <small>Loading...</small>
                        </div>
                    </div>
                </div>
                <div class="analytics-card">
                    <h4>üìä Recent Readings</h4>
                    <div class="recent-list" id="recentReadings">
                        <div class="recent-item">
                            <span>Loading...</span>
                            <small>Loading...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/api-config.js"></script>
    <script src="/js/app.js"></script>
    <script>
        // Use the ElectricityTracker namespace - no duplicate declarations
        const ET = window.ElectricityTracker;
        
        // Check authentication
        if (!ET.auth.checkAuth()) {
            // User will be redirected to login
        } else {
            loadDashboard();
        }
        
        async function loadDashboard() {
            try {
                ET.utils.showLoading(true);
                
                const data = await ET.api.get('/api/dashboard');
                
                if (data) {
                    // Update stats
                    document.getElementById('totalAmount').textContent = ET.utils.formatCurrency(data.totalAmount);
                    document.getElementById('totalUnits').textContent = `${(data.totalUnits || 0).toFixed(1)} kWh`;
                    document.getElementById('avgCost').textContent = `${ET.utils.formatCurrency(data.avgCostPerKwh)}/kWh`;
                    document.getElementById('totalVat').textContent = ET.utils.formatCurrency(data.totalVat);
                    
                    // Display recent vouchers
                    if (data.recentVouchers && data.recentVouchers.length > 0) {
                        const vouchersHtml = data.recentVouchers.map(v => `
                            <div class="item">
                                <span>${ET.utils.formatDate(v.purchase_date)}</span>
                                <span>${ET.utils.formatCurrency(v.rand_amount)} - ${v.kwh_amount} kWh</span>
                            </div>
                        `).join('');
                        document.getElementById('recentVouchers').innerHTML = vouchersHtml;
                    } else {
                        document.getElementById('recentVouchers').innerHTML = '<p>No vouchers yet</p>';
                    }
                    
                    // Display recent readings
                    if (data.recentReadings && data.recentReadings.length > 0) {
                        const readingsHtml = data.recentReadings.map(r => `
                            <div class="item">
                                <span>${ET.utils.formatDate(r.reading_date)}</span>
                                <span>${r.reading_value} kWh</span>
                            </div>
                        `).join('');
                        document.getElementById('recentReadings').innerHTML = readingsHtml;
                    } else {
                        document.getElementById('recentReadings').innerHTML = '<div class="recent-item"><span>No readings yet</span></div>';
                    }
                    
                    // Display monthly data
                    if (data.monthlyData && data.monthlyData.length > 0) {
                        const monthlyHtml = data.monthlyData.map(m => {
                            const avgCost = m.kwh > 0 ? (m.amount / m.kwh) : 0;
                            const monthName = new Date(m.month + '-01').toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'short' 
                            });
                            return `
                                <div class="monthly-card">
                                    <h4>${monthName}</h4>
                                    <h3>${ET.utils.formatCurrency(m.amount)}</h3>
                                    <p>${m.kwh.toFixed(1)} kWh</p>
                                    <small>Avg ${ET.utils.formatCurrency(avgCost)}/kWh</small>
                                </div>
                            `;
                        }).join('');
                        document.getElementById('monthlyGrid').innerHTML = monthlyHtml;
                    } else {
                        document.getElementById('monthlyGrid').innerHTML = '<div class="monthly-card"><h4>No Data</h4><h3>R0.00</h3><p>0 kWh</p><small>No purchases yet</small></div>';
                    }
                }
                
            } catch (error) {
                console.error('Dashboard error:', error);
                ET.utils.showMessage('Failed to load dashboard data', 'error');
            } finally {
                ET.utils.showLoading(false);
            }
        }
    </script>
</body>
</html>