<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Electricity Tracker</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <nav>
        <div class="nav-brand">‚ö° Electricity Tracker</div>
        <div class="nav-links">
            <a href="/dashboard" class="nav-btn">üè† Dashboard</a>
            <a href="/voucher" class="nav-btn">üí≥ Add Voucher</a>
            <a href="/reading" class="nav-btn">üìä Add Reading</a>
            <a href="/history" class="nav-btn">üìù History</a>
            <a href="#" id="logout" class="nav-btn logout">üö™ Log Out</a>
        </div>
    </nav>
    
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>üìä Electricity Tracker Dashboard</h1>
            <p class="dashboard-subtitle">Track your electricity consumption and costs</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-content">
                    <h3>R3217.38</h3>
                    <p>TOTAL SPENT</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ö°</div>
                <div class="stat-content">
                    <h3>1123.9 kWh</h3>
                    <p>TOTAL KWH</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-content">
                    <h3>R2.86/kWh</h3>
                    <p>AVG COST</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìã</div>
                <div class="stat-content">
                    <h3>R0.00</h3>
                    <p>TOTAL VAT</p>
                </div>
            </div>
        </div>

        <div class="dashboard-sections">
            <div class="section-header">
                <h2>üìÖ Last 6 Months</h2>
            </div>
            
            <div class="monthly-grid">
                <div class="monthly-card">
                    <h4>Sep 2025</h4>
                    <h3>R869.56</h3>
                    <p>296.2 kWh</p>
                    <small>Avg R2.94/kWh</small>
                </div>
                <div class="monthly-card">
                    <h4>Aug 2025</h4>
                    <h3>R1304.34</h3>
                    <p>444.5 kWh</p>
                    <small>Avg R2.94/kWh</small>
                </div>
                <div class="monthly-card">
                    <h4>Jul 2025</h4>
                    <h3>R1043.48</h3>
                    <p>383.4 kWh</p>
                    <small>Avg R2.72/kWh</small>
                </div>
            </div>

            <div class="section-header">
                <h2>üìà Usage Analytics</h2>
            </div>
            
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h4>Monthly Consumption</h4>
                    <div class="chart-placeholder">
                        <p>Chart showing monthly usage trends</p>
                    </div>
                </div>
                <div class="analytics-card">
                    <h4>üìÑ Recent Vouchers</h4>
                    <div class="recent-list">
                        <div class="recent-item">
                            <span>R434.78 - 148.1 kWh</span>
                            <small>2025/09/02</small>
                        </div>
                        <div class="recent-item">
                            <span>R434.78 - 148.1 kWh</span>
                            <small>2025/09/02</small>
                        </div>
                        <div class="recent-item">
                            <span>R434.78 - 148.1 kWh</span>
                            <small>2025/08/23</small>
                        </div>
                    </div>
                </div>
                <div class="analytics-card">
                    <h4>üìä Recent Readings</h4>
                    <div class="recent-list">
                        <div class="recent-item">
                            <span>Reading: 280.89</span>
                            <small>2025/09/05</small>
                        </div>
                        <div class="recent-item">
                            <span>Reading: 329.13</span>
                            <small>2025/09/02</small>
                        </div>
                        <div class="recent-item">
                            <span>Reading: 76.78</span>
                            <small>2025/08/30</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/api-config.js"></script>
    <script src="/js/app.js"></script>
    <script>
        // Use the ElectricityTracker namespace - no duplicate declarations
        const ET = window.ElectricityTracker;
        
        // Check authentication
        if (!ET.auth.checkAuth()) {
            // User will be redirected to login
        } else {
            loadDashboard();
        }
        
        async function loadDashboard() {
            try {
                ET.utils.showLoading(true);
                
                const data = await ET.api.get('/api/dashboard');
                
                if (data) {
                    // Update stats
                    document.getElementById('totalVouchers').textContent = data.totalVouchers || 0;
                    document.getElementById('totalAmount').textContent = ET.utils.formatCurrency(data.totalAmount);
                    document.getElementById('totalUnits').textContent = `${(data.totalUnits || 0).toFixed(2)} kWh`;
                    document.getElementById('avgCost').textContent = ET.utils.formatCurrency(data.avgCostPerKwh);
                    
                    // Display recent vouchers
                    if (data.recentVouchers && data.recentVouchers.length > 0) {
                        const vouchersHtml = data.recentVouchers.map(v => `
                            <div class="item">
                                <span>${ET.utils.formatDate(v.purchase_date)}</span>
                                <span>${ET.utils.formatCurrency(v.rand_amount)} - ${v.kwh_amount} kWh</span>
                            </div>
                        `).join('');
                        document.getElementById('recentVouchers').innerHTML = vouchersHtml;
                    } else {
                        document.getElementById('recentVouchers').innerHTML = '<p>No vouchers yet</p>';
                    }
                    
                    // Display recent readings
                    if (data.recentReadings && data.recentReadings.length > 0) {
                        const readingsHtml = data.recentReadings.map(r => `
                            <div class="item">
                                <span>${ET.utils.formatDate(r.reading_date)}</span>
                                <span>${r.reading_value} kWh</span>
                            </div>
                        `).join('');
                        document.getElementById('recentReadings').innerHTML = readingsHtml;
                    } else {
                        document.getElementById('recentReadings').innerHTML = '<p>No readings yet</p>';
                    }
                }
                
            } catch (error) {
                console.error('Dashboard error:', error);
                ET.utils.showMessage('Failed to load dashboard data', 'error');
            } finally {
                ET.utils.showLoading(false);
            }
        }
    </script>
</body>
</html>