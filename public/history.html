<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History - Electricity Tracker</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <nav>
        <div class="nav-brand">‚ö° Electricity Tracker</div>
        <div class="nav-links">
            <a href="/dashboard" class="nav-btn">üè† Dashboard</a>
            <a href="/voucher" class="nav-btn">üí≥ Add Voucher</a>
            <a href="/reading" class="nav-btn">üìä Add Reading</a>
            <a href="/history" class="nav-btn active">üìù History</a>
            <a href="#" id="logout" class="nav-btn logout">üö™ Log Out</a>
        </div>
    </nav>
    
    <div class="history-container">
        <div class="history-header">
            <h1>üìã Transaction History</h1>
            <div class="history-buttons">
                <button class="history-btn active">üìã Show All Data</button>
                <button class="history-btn">üí≥ Add Voucher</button>
                <button class="history-btn">üìä Add Reading</button>
            </div>
        </div>
        
        <div class="history-tabs">
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="vouchers">üí≥ Vouchers</button>
                <button class="tab-btn" data-tab="readings">üìä Readings</button>
                <button class="tab-btn" data-tab="combined">üìã All Combined</button>
            </div>
        </div>
        
        <div class="history-content">
            <div class="history-table-header">
                <h2>üìã All Transactions (Combined)</h2>
                <p>Showing all 26 transactions in chronological order</p>
            </div>
            
            <div class="history-table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>DATE & TIME</th>
                            <th>TYPE</th>
                            <th>DETAILS</th>
                            <th>AMOUNT/VALUE</th>
                            <th>UNITS/USAGE</th>
                            <th>NOTES</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr class="reading-row">
                            <td>2025/09/05, 02:00:00</td>
                            <td><span class="type-badge reading">üìä READING</span></td>
                            <td>Meter Reading</td>
                            <td>280.89 kWh</td>
                            <td>-48.2 kWh used</td>
                            <td>3 days, -16.07 kWh/day</td>
                        </tr>
                        <tr class="voucher-row">
                            <td>2025/09/02, 02:00:00</td>
                            <td><span class="type-badge voucher">üí≥ VOUCHER</span></td>
                            <td>Token: 3714-3240-5853-7054-6208</td>
                            <td>R434.78</td>
                            <td>148.1 kWh</td>
                            <td>-</td>
                        </tr>
                        <tr class="voucher-row">
                            <td>2025/09/02, 02:00:00</td>
                            <td><span class="type-badge voucher">üí≥ VOUCHER</span></td>
                            <td>Token: 0570-5615-4778-6089-1034</td>
                            <td>R434.78</td>
                            <td>148.1 kWh</td>
                            <td>-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
        
        <!-- Filters -->
        <div class="filters card">
            <div class="filter-group">
                <label for="monthFilter">Filter by Month:</label>
                <input type="month" id="monthFilter">
                <button id="filterBtn" class="secondary-btn">Apply Filter</button>
                <button id="clearFilterBtn" class="secondary-btn">Clear</button>
            </div>
            <div class="filter-group">
                <label>
                    <input type="checkbox" id="showVouchers" checked> Show Vouchers
                </label>
                <label>
                    <input type="checkbox" id="showReadings" checked> Show Readings
                </label>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="stats-summary card">
            <h2>Summary</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Total Vouchers:</span>
                    <span id="totalVoucherCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Spent:</span>
                    <span id="totalSpent">R0.00</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Units:</span>
                    <span id="totalUnits">0 kWh</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Readings:</span>
                    <span id="totalReadingCount">0</span>
                </div>
            </div>
        </div>
        
        <!-- Transaction List -->
        <div class="transactions-section">
            <h2>All Transactions</h2>
            <div id="transactionsList">Loading...</div>
        </div>
    </div>
    
    <script src="/api-config.js"></script>
    <script src="/js/app.js"></script>
    <script>
        const ET = window.ElectricityTracker;
        let allVouchers = [];
        let allReadings = [];
        
        // Check authentication
        if (!ET.auth.checkAuth()) {
            // User will be redirected to login
        } else {
            loadTransactions();
            setupFilters();
        }
        
        function setupFilters() {
            // Set current month as default
            const now = new Date();
            const currentMonth = now.toISOString().slice(0, 7);
            document.getElementById('monthFilter').value = currentMonth;
            
            // Filter button
            document.getElementById('filterBtn').addEventListener('click', () => {
                loadTransactions();
            });
            
            // Clear filter
            document.getElementById('clearFilterBtn').addEventListener('click', () => {
                document.getElementById('monthFilter').value = '';
                loadTransactions();
            });
            
            // Checkboxes
            document.getElementById('showVouchers').addEventListener('change', renderTransactions);
            document.getElementById('showReadings').addEventListener('change', renderTransactions);
        }
        
        async function loadTransactions() {
            try {
                const month = document.getElementById('monthFilter').value;
                const endpoint = month ? `/api/transactions?month=${month}` : '/api/transactions';
                
                const data = await ET.api.get(endpoint);
                
                if (data) {
                    allVouchers = data.vouchers || [];
                    allReadings = data.readings || [];
                    
                    updateSummary();
                    renderTransactions();
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                document.getElementById('transactionsList').innerHTML = '<p>Error loading transactions</p>';
            }
        }
        
        function updateSummary() {
            const totalSpent = allVouchers.reduce((sum, v) => sum + (v.rand_amount || 0), 0);
            const totalUnits = allVouchers.reduce((sum, v) => sum + (v.kwh_amount || 0), 0);
            
            document.getElementById('totalVoucherCount').textContent = allVouchers.length;
            document.getElementById('totalSpent').textContent = ET.utils.formatCurrency(totalSpent);
            document.getElementById('totalUnits').textContent = `${totalUnits.toFixed(2)} kWh`;
            document.getElementById('totalReadingCount').textContent = allReadings.length;
        }
        
        function renderTransactions() {
            const showVouchers = document.getElementById('showVouchers').checked;
            const showReadings = document.getElementById('showReadings').checked;
            
            let transactions = [];
            
            // Add vouchers
            if (showVouchers) {
                transactions.push(...allVouchers.map(v => ({
                    ...v,
                    type: 'voucher',
                    date: v.purchase_date,
                    sortDate: new Date(v.purchase_date)
                })));
            }
            
            // Add readings
            if (showReadings) {
                transactions.push(...allReadings.map(r => ({
                    ...r,
                    type: 'reading',
                    date: r.reading_date,
                    sortDate: new Date(r.reading_date)
                })));
            }
            
            // Sort by date (newest first)
            transactions.sort((a, b) => b.sortDate - a.sortDate);
            
            if (transactions.length === 0) {
                document.getElementById('transactionsList').innerHTML = '<p>No transactions found</p>';
                return;
            }
            
            const html = transactions.map(t => {
                if (t.type === 'voucher') {
                    return `
                        <div class="transaction-item voucher-type">
                            <div class="transaction-icon">üí∞</div>
                            <div class="transaction-content">
                                <div class="transaction-header">
                                    <span class="transaction-type">Voucher Purchase</span>
                                    <span class="transaction-date">${ET.utils.formatDateTime(t.date)}</span>
                                </div>
                                <div class="transaction-details">
                                    <span>Amount: ${ET.utils.formatCurrency(t.rand_amount)}</span>
                                    <span>Units: ${t.kwh_amount} kWh</span>
                                    <span>Token: ${t.token_number}</span>
                                    ${t.vat_amount ? `<span>VAT: ${ET.utils.formatCurrency(t.vat_amount)}</span>` : ''}
                                </div>
                                ${t.notes ? `<div class="transaction-notes">${t.notes}</div>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="transaction-item reading-type">
                            <div class="transaction-icon">üìä</div>
                            <div class="transaction-content">
                                <div class="transaction-header">
                                    <span class="transaction-type">Meter Reading</span>
                                    <span class="transaction-date">${ET.utils.formatDateTime(t.date)}</span>
                                </div>
                                <div class="transaction-details">
                                    <span>Reading: ${t.reading_value} kWh</span>
                                </div>
                                ${t.notes ? `<div class="transaction-notes">${t.notes}</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            document.getElementById('transactionsList').innerHTML = html;
        }
    </script>
</body>
</html>