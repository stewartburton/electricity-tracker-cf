<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Electricity Tracker</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="auth-page">
    <div class="auth-container">
        <div class="auth-card">
            <h1>‚ö° Electricity Tracker</h1>
            <p class="tagline">Choose a new password</p>

            <div id="resetStatusMessage" style="display:none;" role="alert"></div>

            <form id="resetPasswordForm" class="auth-form">
                <h2>Reset Password</h2>

                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" minlength="6" required autocomplete="new-password">
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" minlength="6" required autocomplete="new-password">
                </div>

                <button type="submit" class="primary-btn">üîê Update Password</button>
            </form>

            <div class="auth-switch">
                <p>Ready to sign in? <a href="/login">Back to login</a></p>
            </div>
        </div>
    </div>

    <script src="/api-config.js"></script>
    <script src="/js/app.js"></script>
    <script src="/js/theme-effects.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const ET = window.ElectricityTracker;
            if (!ET) {
                console.error('ElectricityTracker not found');
                alert('Application failed to load. Please refresh the page.');
                return;
            }

            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            const statusMessage = document.getElementById('resetStatusMessage');
            const form = document.getElementById('resetPasswordForm');

            if (!token) {
                form.style.display = 'none';
                showMessage('Reset link not found. Please use the password reset email to open this page.', false);
                return;
            }

            function showMessage(message, isSuccess) {
                if (!statusMessage) {
                    return;
                }

                statusMessage.textContent = message;
                statusMessage.style.display = 'block';
                statusMessage.style.backgroundColor = isSuccess ? 'rgba(16, 185, 129, 0.12)' : 'rgba(239, 68, 68, 0.12)';
                statusMessage.style.color = isSuccess ? '#065f46' : '#7f1d1d';
                statusMessage.style.padding = '12px 16px';
                statusMessage.style.borderRadius = '8px';
                statusMessage.style.marginBottom = '16px';
            }

            try {
                const validationEndpoint = '/api/auth/reset-password/validate?token=' + encodeURIComponent(token);
                const result = await ET.api.get(validationEndpoint);
                if (result && result.email) {
                    showMessage('Resetting password for ' + result.email + '.', true);
                }
            } catch (error) {
                console.error('Reset token validation error:', error);
                form.style.display = 'none';
                showMessage(error.message || 'This reset link is invalid or has expired. Please request a new password reset.', false);
                return;
            }

            form.addEventListener('submit', async function(event) {
                event.preventDefault();

                const submitButton = form.querySelector('button[type="submit"]');
                const passwordInput = document.getElementById('newPassword');
                const confirmInput = document.getElementById('confirmPassword');
                const password = passwordInput.value;
                const confirmPassword = confirmInput.value;

                // Debug info for troubleshooting
                console.log('Password reset form submitted');
                console.log('Token present:', !!token);
                console.log('Password length:', password.length);

                if (statusMessage) {
                    statusMessage.style.display = 'none';
                    statusMessage.textContent = '';
                }

                // Basic validation
                if (!passwordInput.checkValidity()) {
                    showMessage('Please enter a valid password', false);
                    return;
                }

                if (!confirmInput.checkValidity()) {
                    showMessage('Please confirm your password', false);
                    return;
                }

                if (password.length < 6) {
                    showMessage('Password must be at least 6 characters long.', false);
                    return;
                }

                if (password !== confirmPassword) {
                    showMessage('Passwords do not match. Please try again.', false);
                    return;
                }

                submitButton.disabled = true;
                submitButton.textContent = 'Updating...';

                try {
                    const response = await ET.api.post('/api/auth/reset-password', { token, password });
                    showMessage(response?.message || 'Password reset successful. You can now log in with your new password.', true);
                    form.reset();
                    form.style.display = 'none';
                } catch (error) {
                    console.error('Password reset error:', error);

                    // Check if this might be the SMS parsing error
                    if (error.message && error.message.includes('pattern')) {
                        console.error('Pattern error detected in password reset context!');
                        showMessage('System error detected. Please try again or contact support.', false);
                    } else {
                        showMessage(error.message || 'Unable to reset your password. Please request a new reset link.', false);
                    }
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'üîê Update Password';
                }
            });
        });
    </script>
</body>
</html>
